<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Dual Markdown ↔ Rich‑Text Editor</title>
  <link rel="icon" href="data:;base64,iVBORw0KGgo="> <!-- Add placeholder favicon -->
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Quill CSS -->
  <link href="https://cdn.jsdelivr.net/npm/quill@2.0.2/dist/quill.snow.css" rel="stylesheet" /> <!-- Updated Quill CSS -->
</head>
<body class="h-screen flex flex-col">
  <!-- Split Pane Wrapper -->
  <div id="editor-wrapper" class="flex flex-1 overflow-hidden">
    <!-- Markdown Pane -->
    <div class="flex flex-col w-1/2 h-full border-r border-gray-300">
      <div class="flex gap-2 p-2 border-b border-gray-300 bg-gray-50">
        <button id="copy-md" class="px-3 py-1 text-sm rounded bg-blue-500 text-white">Copy</button>
        <button id="download-md" class="px-3 py-1 text-sm rounded bg-green-600 text-white">Download</button>
      </div>
      <div id="md-editor" class="flex-1 overflow-auto"></div>
    </div>

    <!-- Rich‑Text Pane -->
    <div class="flex flex-col w-1/2 h-full">
      <div class="flex gap-2 p-2 border-b border-gray-300 bg-gray-50">
        <button id="copy-html" class="px-3 py-1 text-sm rounded bg-blue-500 text-white">Copy</button>
        <button id="download-html" class="px-3 py-1 text-sm rounded bg-green-600 text-white">Download</button>
      </div>
      <div id="rt-editor" class="flex-1 overflow-auto"></div>
    </div>
  </div>

  <!-- Helper Libraries -->
  <script src="https://cdn.jsdelivr.net/npm/showdown@2.1.0/dist/showdown.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/turndown@7.1.2/dist/turndown.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/quill@2.0.2/dist/quill.js"></script> <!-- Updated Quill JS -->

  <!-- CodeMirror & App Logic -->
  <script type="module">
    // Import only the essential CodeMirror packages to minimize version conflicts
    import { EditorState } from "https://cdn.jsdelivr.net/npm/@codemirror/state@6.4.1/+esm";
    import { EditorView, keymap } from "https://cdn.jsdelivr.net/npm/@codemirror/view@6.26.3/+esm";
    import { defaultKeymap } from "https://cdn.jsdelivr.net/npm/@codemirror/commands@6.5.0/+esm";
    // Removed markdown import which was causing deserialize issues

    // Initialize CodeMirror (Markdown side) with minimal configuration
    const mdParent = document.getElementById('md-editor');

    // Create the editor with minimal extensions to avoid conflicts
    const startState = EditorState.create({
      doc: '',
      extensions: [
        keymap.of(defaultKeymap),
        EditorView.updateListener.of(update => {
          if (update.docChanged && !isUpdating) {
            isUpdating = true;
            const markdownText = update.state.doc.toString();
            const html = showdownConverter.makeHtml(markdownText);
            quill.root.innerHTML = html;
            isUpdating = false;
          }
        })
      ]
    });

    const mdView = new EditorView({
      state: startState,
      parent: mdParent
    });

    // Initialize Quill (Rich‑Text side)
    const quill = new Quill('#rt-editor', { theme: 'snow' });

    // Converters
    const showdownConverter = new showdown.Converter({
      tables: true,
      strikethrough: true,
      tasklists: true
    });
    const turndownService = new TurndownService();

    // Two‑way sync guards
    let isUpdating = false;

    // Rich‑Text → Markdown
    quill.on('text-change', (delta, oldDelta, source) => {
      if (source === 'user' && !isUpdating) {
        isUpdating = true;
        const html = quill.root.innerHTML;
        const markdown = turndownService.turndown(html);
        mdView.dispatch({
          changes: { from: 0, to: mdView.state.doc.length, insert: markdown }
        });
        isUpdating = false;
      }
    });

    // ── Utility helpers ────────────────────────────────────────────────
    function sanitizeFilename(str) {
      return (str || 'untitled').replace(/[^\w\d\s-]/g, '').trim().slice(0, 50) || 'untitled';
    }

    function copy(text) {
      navigator.clipboard.writeText(text).catch(err => alert('Copy failed: ' + err));
    }

    function download(text, filename) {
      const blob = new Blob([text], { type: 'text/plain;charset=utf-8' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      a.click();
      URL.revokeObjectURL(url);
    }

    // ── Button wiring ─────────────────────────────────────────────────
    document.getElementById('copy-md').addEventListener('click', () => {
      copy(mdView.state.doc.toString());
    });

    document.getElementById('copy-html').addEventListener('click', () => {
      copy(quill.root.innerHTML);
    });

    document.getElementById('download-md').addEventListener('click', () => {
      const md = mdView.state.doc.toString();
      const first = md.split('\n').find(l => l.trim()) || 'untitled';
      download(md, sanitizeFilename(first) + '.md');
    });

    document.getElementById('download-html').addEventListener('click', () => {
      const text = quill.getText();
      const first = text.split('\n').find(l => l.trim()) || 'untitled';
      download(quill.root.innerHTML, sanitizeFilename(first) + '.html');
    });
  </script>
</body>
</html>